name: Secret Scan

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch: {}

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Search for private key patterns
        run: |
          set -e
          echo "Scanning repository for private key patterns..."
          MATCHES=$(grep -R -I -nE "(BEGIN PRIVATE KEY|BEGIN ED25519 PRIVATE KEY|-----BEGIN OPENSSH PRIVATE KEY-----|PRIVATE KEY-----)" || true)
          if [ -n "$MATCHES" ]; then
            echo "Potential private key occurrences found:";
            echo "$MATCHES";
            echo "$MATCHES" > secret-scan-matches.txt
            tar -czf secret-scan-matches.tgz secret-scan-matches.txt || true
            exit 1
          fi
          echo "No private key patterns found."
      - name: Upload matches (if any)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-matches
          path: secret-scan-matches.tgz
