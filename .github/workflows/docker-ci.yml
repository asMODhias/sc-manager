name: Docker CI (Compose)

on:
  push:
  pull_request:

jobs:
  docker-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build & cache core image
        uses: docker/build-push-action@v4
        with:
          context: ./core
          file: ./core/Dockerfile
          push: false
          load: true
          tags: docker-core:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & cache adapters image
        uses: docker/build-push-action@v4
        with:
          context: ./adapters
          file: ./adapters/Dockerfile
          push: false
          load: true
          tags: docker-adapters:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & cache ui image
        uses: docker/build-push-action@v4
        with:
          context: ./ui
          file: ./ui/Dockerfile
          push: false
          load: true
          tags: docker-ui:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & cache e2e image
        uses: docker/build-push-action@v4
        with:
          context: ./e2e
          file: ./e2e/Dockerfile
          push: false
          load: true
          tags: docker-e2e:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & cache integration image
        uses: docker/build-push-action@v4
        with:
          context: ./app
          file: ./app/Dockerfile
          push: false
          load: true
          tags: docker-integration:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Enable pnpm
        run: corepack enable && corepack prepare pnpm@latest --activate

      - name: Enable turbo
        run: corepack prepare turbo@latest --activate

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml', '**/package-lock.json') }}

      - name: Build images (parallel)
        run: docker compose -f docker/docker-compose.ci.yml build --parallel

      - name: Run CI via docker-compose (abort on first failing service)
        id: compose
        run: |
          docker compose -f docker/docker-compose.ci.yml up --abort-on-container-exit --exit-code-from core || true

      - name: Collect container logs
        if: always()
        run: |
          mkdir -p ci-logs
          # collect compose logs
          docker compose -f docker/docker-compose.ci.yml logs --no-color > ci-logs/compose.log || true
          # collect individual container logs
          docker compose -f docker/docker-compose.ci.yml ps -q | xargs -r -n1 -I{} bash -c 'docker logs {} > ci-logs/{}.log || true'

      - name: Upload CI logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: ci-logs

      - name: Tear down
        if: always()
        run: docker compose -f docker/docker-compose.ci.yml down --volumes --remove-orphans