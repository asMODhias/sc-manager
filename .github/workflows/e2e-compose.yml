name: E2E Compose Integration

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: {}

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        rust_log: [info, debug]
    env:
      NATS_URL: nats://127.0.0.1:4222
      GATEWAY_BIND: 0.0.0.0:8080
      ADAPTERS: discord
      DISCORD_SCHEDULE_SECONDS: "1"
      ADAPTER_FETCH_MAX_RETRIES: "1"
      ADAPTER_FETCH_BACKOFF_MS: "100"
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/sc_manager
      REDIS_URL: redis://redis:6379
      RUST_LOG: ${{ matrix.rust_log }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Ensure Docker Compose available
        run: docker compose version

      - name: Start background NATS subscriber (capture early messages)
        run: |
          echo "Starting background NATS subscriber"
          python -m pip install --user nats-py
          nohup python e2e/scripts/nats_subscriber.py > e2e/nats_sub.log 2>&1 & echo $! > e2e/nats_sub.pid || true

      - name: Start E2E stack (NATS + Gateway locally)
        shell: pwsh
        run: |
          Write-Host "Starting E2E stack (NATS + gateway locally)"
          Set-Location ${{ github.workspace }}
          # Start nats container and gateway locally under PowerShell Job
          ./e2e/scripts/start-e2e.ps1 -LocalGateway -TimeoutSeconds 90

      - name: Wait for gateway health (poll up to 90s)
        run: |
          echo "Waiting for gateway /health to become available (up to 90s)"
          for i in `seq 1 45`; do
            if curl -sS http://localhost:8080/health | grep -q '"status"\s*:\s*"ok"'; then
              echo "gateway ready"; break;
            fi
            sleep 2
          done
          if ! curl -sS http://localhost:8080/health | grep -q '"status"\s*:\s*"ok"'; then
            echo "Gateway did not become healthy within timeout"; docker compose -f e2e/docker-compose.e2e.yml logs --no-color --timestamps --tail 200 > e2e/docker-logs.txt || true; exit 1
          fi

      - name: Wait for a short warmup for adapters to publish (poll)
        run: |
          echo "Waiting for adapters to publish metrics"
          for i in `seq 1 30`; do
            curl -sS http://localhost:8080/metrics | tee metrics.txt >/dev/null
            if grep -q "adapter_fetch_success_total" metrics.txt; then
              echo "adapter metrics present"; break;
            fi
            sleep 2
          done
          if ! grep -q "adapter_fetch_success_total" metrics.txt; then
            echo "Adapter metrics not found after wait"; cat metrics.txt || true; exit 1
          fi

      - name: Verify domain.events published (NATS + signature + payload checks)
        run: |
          python -m pip install --user nats-py
          # If background subscriber already wrote signed_msg.json, prefer it
          if [ -f signed_msg.json ]; then
            echo "Using existing signed_msg.json (captured by background subscriber)";
            cat signed_msg.json | tee signed_msg.json.tmp;
          else
            python e2e/scripts/fetch_signed_msg.py signed_msg.json.tmp
          fi

          # Validate structure & payload content
          python e2e/scripts/validate_signed_msg.py signed_msg.json.tmp

          # run Rust verifier
          rc = cargo run -p verify_signed_event --quiet -- signed_msg.json.tmp || true
          if [ $? -ne 0 ]; then
            echo 'Rust verifier failed'; exit 3; fi
          echo 'Signature verified and payload checks passed'

      - name: Check Postgres writes via core-app integration test
        run: |
          echo "Initializing Postgres schema from e2e/sql/init.sql"
          docker cp e2e/sql/init.sql $(docker compose -f e2e/docker-compose.e2e.yml ps -q postgres):/tmp/init.sql || true
          docker compose -f e2e/docker-compose.e2e.yml exec -T postgres psql -U postgres -d sc_manager -f /tmp/init.sql || true

          echo "Running core-application integration tests (NATS->Postgres...)"
          export RUN_INTEGRATION_TESTS=1
          export DATABASE_URL=${{ env.DATABASE_URL }}
          export NATS_URL=${{ env.NATS_URL }}
          cargo test -p sc_manager_app --test integration_e2e -- --nocapture || true
          if [ $? -ne 0 ]; then echo "Integration tests failed"; exit 4; fi

      - name: Upload metrics artifact (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-metrics
          path: metrics.txt

      - name: Archive Docker Compose logs on failure
        if: failure()
        run: |
          echo "Gathering docker compose logs"
          docker compose -f e2e/docker-compose.e2e.yml logs --no-color --timestamps > e2e/docker-logs.txt || true
          echo "Process list" > e2e/processes.txt
          ps aux >> e2e/processes.txt || true
        continue-on-error: true

      - name: Upload logs artifact on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: e2e/

      - name: Post failure comment on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const message = `E2E Compose job failed. Logs and metrics have been uploaded as artifacts. See the run: ${runUrl}`;
            github.rest.issues.createComment({ issue_number: github.context.payload.pull_request.number, owner: github.context.repo.owner, repo: github.context.repo.repo, body: message });

      - name: Tear down E2E stack
        if: always()
        run: docker compose -f e2e/docker-compose.e2e.yml down --volumes --remove-orphans || true
